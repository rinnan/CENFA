#' Climatic vulnerability
#'
#' Calculates the climatic vulnerability of a species using a \code{cnfa} and
#' \code{departure} object.
#'
#' @param cnfa Object of class \code{cnfa}
#' @param dep Object of class \code{departure}
#' @param parallel logical. If \code{TRUE} then multiple cores are utilized
#' @param n numeric. Number of cores to use for calculation (optional)
#' @param filename character. Output filename (optional)
#' @param ... Additional arguments for file writing as for \code{\link[raster]{writeRaster}}
#'
#' @details
#' The values of the vulnerability raster are calculated by projecting onto
#' the departure factor \strong{d}, given by formula
#'
#'   \eqn{\nu} = \bold{Fv}.
#'
#' @examples
#' mod1 <- cnfa(x = climdat.hist, s.dat = ABPR, field = "CODE")
#' dep <- departure(x.hist = climdat.hist, x.fut = climdat.fut, s.dat = ABPR)
#' vuln <- vulnerability(cnfa = mod1, dep = dep)
#'
#' @return Returns an S4 object of class \code{vulnerability} with the following slots:
#' \describe{
#'   \item{call}{Original function call}
#'   \item{vf}{Vulnerability factor. Vector of length p that describes the amount of
#'    vulnerability in each climate variable}
#'   \item{vulnerability}{Magnitude of the vulnerability factor}
#'   \item{ras}{RasterLayer of climate vulnerability}
#'   \item{weights}{Raster layer of weights used for departure calculation}
#' }
#'
#' @seealso \code{\link{departure}}
#'
#' @export

setGeneric("vulnerability", function(cnfa, dep, ...) {
  standardGeneric("vulnerability")
})

#' @rdname vulnerability
setMethod("vulnerability",
          signature(cnfa = "cnfa", dep = "departure"),
          function(cnfa, dep, parallel = FALSE, n, filename = "", ...) {

            call <- sys.calls()[[1]]

            co <- cnfa@co
            p <- cnfa@p.spec
            d <- dep@df
            ras <- dep@ras

            v <- as.numeric(diag(d) %*% abs(co) %*% p)
            names(v) <- names(d)
            V <- norm(v, "2")

            filename <- trim(filename)
            if (!canProcessInMemory(ras) && filename == '') {
              filename <- rasterTmpFile()
            }

            f1 <- function(x) x %*% v

            if(parallel) {
              beginCluster(n, exclude = "CENFA")
              vuln.ras <- clusterR(ras, fun = .calc, args = list(fun = f1, forceapply = T, names = "Vulnerability"), filename = filename, ...)
              endCluster()
            } else {
              vuln.ras <- .calc(ras, fun = f1, forceapply = T, filename = filename, names = "Vulnerability", ...)
            }

            vuln <- methods::new("vulnerability", call = call, vf = v, vulnerability = V, ras = vuln.ras, weights = dep@weights)
            return(vuln)
          }
)


